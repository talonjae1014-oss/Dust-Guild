<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â˜ï¸ ë¨¼ì§€ ê¸¸ë“œì „ (Deep Night)</title>
<style>
  /* --- [ìŠ¤íƒ€ì¼] Deep Night & Starlight Contrast --- */
  :root {
    /* ë°°ê²½: ì™„ì „í•œ ì–´ë‘  ~ ê¹Šì€ ë„¤ì´ë¹„ */
    --bg-gradient: linear-gradient(to bottom, #02010a, #040416, #0b0b2e);
    
    /* í…ìŠ¤íŠ¸ */
    --text-main: #FFFFFF;
    --text-sub: #D1D1D1;
    
    /* í¬ì¸íŠ¸: ì•„ì´ìŠ¤ ë¸”ë£¨ */
    --accent: #B3E5FC; 
    --accent-glow: rgba(179, 229, 252, 0.6);
    
    /* ì¹´ë“œ ë””ìì¸ */
    --card-bg: rgba(20, 30, 50, 0.6); 
    --card-border: rgba(255, 255, 255, 0.12);
    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
    --backdrop-blur: blur(8px);
    --radius: 16px;
  }

  body {
    background: var(--bg-gradient);
    min-height: 100vh;
    color: var(--text-main);
    font-family: 'Suit', sans-serif;
    margin: 0; padding: 20px; padding-bottom: 100px;
    line-height: 1.6;
    position: relative;
    overflow-x: hidden;
  }

  /* ë°°ê²½ ë³„ íš¨ê³¼ */
  #starfield {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: -1;
    background-image: 
      radial-gradient(1.5px 1.5px at 10% 10%, #FFF, rgba(0,0,0,0)),
      radial-gradient(1.5px 1.5px at 20% 30%, #FFF, rgba(0,0,0,0)),
      radial-gradient(2px 2px at 40% 70%, #E3F2FD, rgba(0,0,0,0)),
      radial-gradient(1.5px 1.5px at 60% 40%, #FFF, rgba(0,0,0,0)),
      radial-gradient(2.5px 2.5px at 80% 80%, #B3E5FC, rgba(0,0,0,0)),
      radial-gradient(1.5px 1.5px at 90% 20%, #FFF, rgba(0,0,0,0)),
      radial-gradient(1px 1px at 50% 50%, #FFF, rgba(0,0,0,0));
    background-size: 300px 300px;
    opacity: 0.8; 
  }

  h2, h3, h4 { margin-top: 0; color: var(--text-main); font-weight: 700; letter-spacing: -0.5px; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
  h2 { font-size: 1.8rem; }
  
  button {
    cursor: pointer; border: none; padding: 12px 18px; border-radius: 10px;
    font-weight: bold; transition: 0.3s; font-size: 0.9rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  }
  button:hover { transform: translateY(-2px); box-shadow: 0 0 15px var(--accent-glow); }
  
  /* ê³µí†µ ìœ ë¦¬ ì¹´ë“œ */
  .glass-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    backdrop-filter: var(--backdrop-blur); -webkit-backdrop-filter: var(--backdrop-blur);
    box-shadow: var(--card-shadow);
    border-radius: var(--radius);
  }

  input, select, textarea {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--card-border); color: #FFF;
    padding: 14px; border-radius: 10px; width: 100%;
    box-sizing: border-box; margin-bottom: 8px;
    font-size: 0.95rem; outline: none; transition: 0.3s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent);
    background: rgba(0, 0, 0, 0.6);
  }
  input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.3); }
  
  select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23B3E5FC' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 14px center;
    background-size: 16px;
  }
  select option { background: #0b0b2e; color: #fff; }

  /* ë“œë¡­ë‹¤ìš´ Wrapper */
  .dropdown-wrapper { position: relative; margin-bottom: 25px; z-index: 100; }
  .glass-box {
    background: var(--card-bg); border: 1px solid var(--card-border);
    backdrop-filter: var(--backdrop-blur);
    box-shadow: var(--card-shadow); border-radius: var(--radius);
    padding: 20px; display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; transition: 0.3s;
  }
  .glass-box:hover { border-color: var(--accent); background: rgba(255,255,255,0.05); }
  
  .dropdown-list {
    display: none; position: absolute; top: 100%; left: 0; width: 100%;
    background: #02010a; 
    border: 1px solid var(--card-border); border-radius: var(--radius);
    margin-top: 8px; max-height: 400px; overflow-y: auto;
    box-shadow: 0 15px 50px rgba(0,0,0,0.9);
  }
  .dropdown-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: var(--text-main); }
  .dropdown-item:hover { background: rgba(179, 229, 252, 0.1); color: var(--accent); }
  
  .dropdown-add-btn {
    text-align: center; color: var(--accent); font-weight: bold; 
    border-top: 1px dashed rgba(255,255,255,0.2); background: rgba(255,255,255,0.03);
  }

  /* ê³µê²©íŒ€ ë¦¬ìŠ¤íŠ¸ */
  #attackList {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px; margin-bottom: 20px;
  }
  .attack-btn {
    background: rgba(255, 255, 255, 0.03); border: 1px solid var(--card-border);
    color: var(--text-sub); padding: 15px 5px; border-radius: 12px;
    min-height: 85px; text-align: center;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.3s;
  }
  .attack-btn.active {
    background: rgba(179, 229, 252, 0.15); border: 1px solid var(--accent);
    color: #FFF; font-weight: bold;
    box-shadow: 0 0 15px var(--accent-glow);
  }

  /* ìƒì„¸ ì •ë³´ ì¹´ë“œ */
  #attackCard {
    background: rgba(10, 15, 30, 0.7); border: 1px solid var(--card-border);
    backdrop-filter: var(--backdrop-blur);
    box-shadow: var(--card-shadow); border-radius: var(--radius);
    padding: 25px; display: none; margin-bottom: 30px;
  }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
  .info-item { 
    background: rgba(0, 0, 0, 0.4); 
    padding: 12px; border-radius: 8px; font-size: 0.95rem; 
    border: 1px solid rgba(255, 255, 255, 0.05); color: #EEE;
  }
  .info-label { display: block; color: var(--accent); font-size: 0.75rem; margin-bottom: 5px; font-weight: bold; }
  
  /* ìŠ¹íŒ¨ ë²„íŠ¼ */
  .btn-win { background: linear-gradient(135deg, #1b5e20, #2e7d32); color: #FFF; width: 48%; padding: 15px; border: 1px solid #43a047; }
  .btn-lose { background: linear-gradient(135deg, #b71c1c, #c62828); color: #FFF; width: 48%; padding: 15px; border: 1px solid #e53935; }
  .btn-win:hover { box-shadow: 0 0 20px rgba(76, 175, 80, 0.4); }
  .btn-lose:hover { box-shadow: 0 0 20px rgba(244, 67, 54, 0.4); }

  /* ë­í‚¹ ë¦¬ìŠ¤íŠ¸ */
  .rank-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 0.95rem;
    color: var(--text-main);
  }

  /* --- [ê´€ë¦¬ì íŒ¨ë„ ìˆ˜ì •: ë²„ê·¸ ë°©ì§€] --- */
  #adminPanel {
    /* ë°°ê²½: ë¸”ëŸ¬ ì œê±°í•˜ê³  ì§„í•œ ë¸”ë™ ë°˜íˆ¬ëª…ìœ¼ë¡œ ë³€ê²½ (ë Œë”ë§ ì•ˆì •ì„± í™•ë³´) */
    background: rgba(0, 0, 0, 0.9); 
    border: 1px solid rgba(255, 255, 255, 0.2);
    /* backdrop-filter: blur(12px); <-- ì´ ë¶€ë¶„ì´ ë²„ê·¸ì˜ ì›ì¸ì´ë¯€ë¡œ ì œê±° */
    padding: 20px; border-radius: 12px; margin-top: 30px; display: none;
    box-shadow: 0 10px 50px rgba(0,0,0,0.95);
    position: relative; z-index: 500;
  }
  .mini-btn { padding: 6px 10px; font-size: 0.8rem; margin-left: 2px; border-radius: 6px; }
  
  .bg-blue { background: rgba(21, 101, 192, 0.9); color: #FFF; border: 1px solid rgba(255,255,255,0.1); }
  .bg-red { background: rgba(198, 40, 40, 0.9); color: #FFF; border: 1px solid rgba(255,255,255,0.1); }

  /* í‚¤ ê´€ë¦¬ ë¦¬ìŠ¤íŠ¸ */
  .key-row {
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 5px; border-radius: 6px; font-size: 0.9rem;
    border: 1px solid rgba(255,255,255,0.05);
  }

  /* ì œë³´ ëª¨ë‹¬ */
  #suggestModal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 2000;
    align-items: center; justify-content: center; backdrop-filter: blur(5px);
  }
  .modal-content {
    background: #0b0b2e; 
    border: 1px solid var(--accent); box-shadow: 0 0 30px rgba(179, 229, 252, 0.1); border-radius: var(--radius);
    padding: 25px; width: 90%; max-width: 400px; color: var(--text-main);
  }
  .suggest-item {
    background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
  }

  footer {
    text-align: center; margin-top: 50px; padding: 20px;
    color: rgba(255,255,255,0.3); font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.05);
  }
</style>
</head>
<body>

<div id="starfield"></div>

<div id="loginScreen" style="text-align:center; margin-top:100px;">
  <div style="font-size:3.5rem; margin-bottom:10px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.8));">â˜ï¸</div>
  <h2 style="font-size:2.2rem; margin-bottom:30px; color:var(--text-main); text-shadow: 0 0 20px rgba(179, 229, 252, 0.5);">ë¨¼ì§€ ê¸¸ë“œì „</h2>
  
  <div class="glass-card" style="padding:30px; display:inline-block; width: 80%; max-width: 300px; border: 1px solid rgba(255,255,255,0.15);">
    <p style="color:var(--text-sub); font-size:0.85rem; margin-bottom:20px;">ë¨¼ì§€ë“¤ì˜ ê¸¸ë“œì „ì„ ìœ„í•˜ì—¬â€¦</p>
    <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„" style="text-align:center; background:rgba(0,0,0,0.5);">
    <input type="password" id="codeInput" placeholder="CODE (6ìë¦¬)" style="text-align:center; letter-spacing: 5px; background:rgba(0,0,0,0.5);">
    <button onclick="tryLogin()" style="width:100%; background:var(--accent); color:#02010a; margin-top:15px; font-size:1rem; padding:15px; box-shadow: 0 0 20px var(--accent-glow);">ì…ì¥í•˜ê¸°</button>
  </div>
  
  <div style="margin-top:40px;">
    <button onclick="adminLogin()" style="background:transparent; color:rgba(255,255,255,0.4); font-size:0.8rem; box-shadow:none; border:1px solid rgba(255,255,255,0.1);">[ ê´€ë¦¬ì ì „ìš© ]</button>
  </div>
</div>

<div id="mainScreen" style="display:none; max-width: 600px; margin: 0 auto;">
  
  <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
    <div>
      <div id="currentNick" style="color:var(--text-main); font-weight:bold; font-size:1.2rem; margin-bottom:4px; text-shadow: 0 0 10px rgba(255,255,255,0.3);"></div>
      <div id="myStats" style="color:var(--text-sub); font-size:0.85rem;">ë‚´ ì „ì  ë¡œë”©ì¤‘...</div>
    </div>
    <button onclick="toggleAdmin()" id="adminBtn" style="background:rgba(255,255,255,0.08); color:var(--text-main); font-size:0.8rem; padding:6px 12px; border:1px solid var(--card-border);">+ ê´€ë¦¬ì</button>
  </div>

  <div class="dropdown-wrapper">
    <div style="color:var(--text-sub); font-size:0.8rem; margin-bottom:5px; margin-left:5px;">ğŸ›¡ï¸ ë°©ì–´íŒ€ ì„ íƒ</div>
    <div class="glass-box" onclick="toggleDropdown()">
      <span id="defCurrentText" style="font-weight:bold; color:var(--text-main);">ë°©ì–´íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
      <span style="color:var(--accent);">â–¼</span>
    </div>
    
    <div id="defListDropdown" class="dropdown-list">
      <div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.1); background:#02010a; position:sticky; top:0; z-index:10;">
        <input type="text" id="defSearchInput" placeholder="ğŸ” ë°©ì–´íŒ€ ê²€ìƒ‰..." style="margin:0;" oninput="filterDefense()" onclick="event.stopPropagation()">
      </div>
      <div id="defRealList"></div>
      <div id="defAddBtnArea"></div>
    </div>
  </div>

  <div id="attackList"></div>
  
  <div id="suggestBtnArea" style="text-align:center; margin-bottom:20px; display:none;">
    <button onclick="openSuggestModal()" style="background:rgba(255,255,255,0.05); border:1px dashed rgba(255,255,255,0.3); color:var(--text-sub); width:100%; padding:15px;">
      + ê³µê²©ë± ì œë³´í•˜ê¸° (ìœ ì € ì°¸ì—¬)
    </button>
  </div>

  <div id="attackCard">
    <h2 style="border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px; margin-bottom:10px;">
      <span id="cardFire"></span> <span id="cardName" style="color:var(--text-main); text-shadow: 0 0 8px rgba(255,255,255,0.5);"></span>
      <span style="float:right; font-size:0.6em; color:var(--text-sub); font-weight:normal;">
        ìŠ¹ë¥  <span id="cardRate" style="color:var(--accent); font-size:1.4em; font-weight:bold; text-shadow: 0 0 10px var(--accent-glow);">0</span>%
      </span>
      <div id="cardMaker" style="font-size:0.4em; color:rgba(255,255,255,0.5); font-weight:normal; margin-top:5px;"></div>
    </h2>
    <div class="info-grid">
      <div class="info-item"><span class="info-label">ì „ì </span><span id="cardWin">0</span>ìŠ¹ <span id="cardLose">0</span>íŒ¨</div>
      <div class="info-item"><span class="info-label">íƒ€ì…</span><span id="cardType">-</span></div>
      
      <div class="info-item"><span class="info-label">ë°˜ì§€</span><span id="cardRing">-</span></div>
      <div class="info-item"><span class="info-label">í«</span><span id="cardPet">-</span></div>
      
      <div class="info-item" style="grid-column: span 2;"><span class="info-label">ìŠ¤í‚¬ìˆœì„œ</span><span id="cardSkill">-</span></div>
      
      <div class="info-item" style="grid-column: span 2;"><span class="info-label">ì¥ë¹„ì„¸íŒ… ë° íŠ¹ì´ì‚¬í•­</span><span id="cardArmor">-</span></div>
      <div class="info-item" style="grid-column: span 2;"><span class="info-label">ìµœê·¼ 5ê²½ê¸°</span><div id="recentRecord" style="font-size:1.2rem; letter-spacing:3px;">-</div></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button class="btn-win" onclick="addWin()">ğŸ† ìŠ¹ë¦¬</button>
      <button class="btn-lose" onclick="addLose()">ğŸ’€ íŒ¨ë°°</button>
    </div>
    <div style="text-align:right; margin-top:10px;">
       <button onclick="resetRecord()" style="background:transparent; color:rgba(255,255,255,0.3); font-size:0.8rem; text-decoration:underline; box-shadow:none;">[ê´€ë¦¬ì] ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div style="margin-top:40px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
    <h3 style="color:var(--text-main); font-size:1rem;">â˜ï¸ ëª…ì˜ˆì˜ ì „ë‹¹ (ìŠ¹ë¦¬ ë­í‚¹)</h3>
    <div id="rankingList" class="glass-card" style="padding: 0; overflow: hidden; background:rgba(0,0,0,0.2);"></div>
    <div id="moreRankMsg" style="text-align:center; color:rgba(255,255,255,0.3); font-size:0.8rem; margin-top:10px; display:none;">* 11ìœ„ ì´í•˜ëŠ” ê´€ë¦¬ìì—ê²Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <div id="adminPanel">
    <h3>ğŸ› ï¸ ê´€ë¦¬ì íŒ¨ë„</h3>
    
    <div style="background:rgba(0,0,0,0.4); padding:15px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); margin-bottom:20px;">
      <h4 style="color:var(--accent);">ğŸ”‘ ê¸¸ë“œì› ì ‘ì† í‚¤ ê´€ë¦¬</h4>
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input type="text" id="newUserNick" placeholder="ê¸¸ë“œì› ë‹‰ë„¤ì„" style="margin:0;">
        <button onclick="issueKey()" style="background:#2E7D32; color:#fff; width:80px;">ë°œê¸‰</button>
      </div>
      <div id="userKeyList" style="max-height:200px; overflow-y:auto; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;"></div>
    </div>

    <div style="background:rgba(0,0,0,0.4); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); margin-bottom:20px;">
      <h4 style="color:#EF5350;">ğŸ”” ëŒ€ê¸° ì¤‘ì¸ ì œë³´</h4>
      <div id="suggestionList" style="color:var(--text-sub); font-size:0.9rem;">(ì œë³´ëœ ë±ì´ ì—†ìŠµë‹ˆë‹¤)</div>
    </div>

    <div style="margin-bottom:20px;">
      <h4>ë°©ì–´íŒ€ ê´€ë¦¬</h4>
      <input type="text" id="defName" placeholder="ìƒˆ ë°©ì–´íŒ€ ì´ë¦„">
      <button onclick="addDefense()" style="background:#455A64; color:#fff;">ì¶”ê°€</button>
      <button onclick="delDefense()" style="background:#C62828; color:#fff;">í˜„ì¬ ë°©ì–´íŒ€ ì‚­ì œ</button>
    </div>
    
    <div style="margin-bottom:20px;">
      <h4>ê³µê²©íŒ€ ì§ì ‘ ì¶”ê°€</h4>
      <input type="text" id="atkName" placeholder="ê³µê²©íŒ€ ì´ë¦„">
      <select id="atkType">
        <option value="" disabled selected>íƒ€ì… ì„ íƒ (í•„ìˆ˜)</option>
        <option value="ì†ê³µ ë”°ì•¼ í•¨">âš¡ ì†ê³µ ë”°ì•¼ í•¨</option>
        <option value="ë‚´ì¤˜ë„ ë¨">ğŸ›¡ï¸ ë‚´ì¤˜ë„ ë¨</option>
      </select>
      
      <div style="display:flex; gap:5px;">
        <input type="text" id="ringRec" placeholder="ë°˜ì§€">
        <input type="text" id="atkPet" placeholder="í« (ì„ íƒ)">
      </div>

      <textarea id="armorRec" rows="2" placeholder="ì¥ë¹„ì„¸íŒ… ë° íŠ¹ì´ì‚¬í•­"></textarea>
      <input type="text" id="skillOrder" placeholder="ìŠ¤í‚¬ ìˆœì„œ">
      <div style="margin-top:5px;">
        <button onclick="addAttack()" style="background:#455A64; color:#fff;">ì¶”ê°€</button>
        <button onclick="editAttack()" style="background:#1565C0; color:#fff;">ìˆ˜ì • ì €ì¥</button>
        <button onclick="delAttack()" style="background:#C62828; color:#fff;">ì‚­ì œ</button>
      </div>
    </div>
    <hr style="border-color:rgba(255,255,255,0.1); margin:20px 0;">
    <h4>ğŸ‘¥ ìœ ì € ìŠ¹íŒ¨ ìˆ˜ì •</h4>
    <div id="adminUserList" style="max-height:300px; overflow-y:auto; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1);"></div>
  </div>

  <footer>
    <div style="margin-bottom:5px;">Designed & Developed by <b>ë¨¼ì§€</b></div>
    <div style="font-size:0.7rem; color:rgba(255,255,255,0.3);">Copyright Â© 2024 Dust Guild. All rights reserved.</div>
  </footer>
</div>

<div id="suggestModal">
  <div class="modal-content">
    <h3 style="color:var(--text-main);">ğŸ’¡ ê³µê²©ë± ì œë³´</h3>
    <p style="color:var(--text-sub); font-size:0.8rem; margin-bottom:15px;">ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë©ë‹ˆë‹¤.</p>
    <input type="text" id="sugName" placeholder="ê³µê²©íŒ€ ì´ë¦„ (í•„ìˆ˜)">
    <select id="sugType">
      <option value="" disabled selected>íƒ€ì… ì„ íƒ (í•„ìˆ˜)</option>
      <option value="ì†ê³µ ë”°ì•¼ í•¨">âš¡ ì†ê³µ ë”°ì•¼ í•¨</option>
      <option value="ë‚´ì¤˜ë„ ë¨">ğŸ›¡ï¸ ë‚´ì¤˜ë„ ë¨</option>
    </select>
    
    <div style="display:flex; gap:5px;">
      <input type="text" id="sugRing" placeholder="ë°˜ì§€">
      <input type="text" id="sugPet" placeholder="í«">
    </div>

    <textarea id="sugArmor" rows="2" placeholder="ì¥ë¹„ì„¸íŒ… ë° íŠ¹ì´ì‚¬í•­"></textarea>
    <input type="text" id="sugSkill" placeholder="ìŠ¤í‚¬ ìˆœì„œ">
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="submitSuggestion()" style="flex:1; background:var(--accent); color:#02010a; font-weight:bold;">ì œë³´í•˜ê¸°</button>
      <button onclick="closeSuggestModal()" style="flex:1; background:rgba(255,255,255,0.1); color:var(--text-main);">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCZHWLw-qci0WoRiSxviEV4rTtGXyiF6Mo",
  authDomain: "dust-guild.firebaseapp.com",
  databaseURL: "https://dust-guild-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dust-guild",
  storageBucket: "dust-guild.firebasestorage.app",
  messagingSenderId: "735022364594",
  appId: "1:735022364594:web:a4ba424b06f90c1b9b56ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PW = "0918";

let myNick = "";
let currentDefense = "";
let currentAttack = "";
let adminOpen = false;
let allLogsCache = []; 
let defenseDataCache = {}; 

window.onload = () => {
  const storedNick = localStorage.getItem("nickname");
  const storedKey = localStorage.getItem("accessKey");
  
  if (storedNick && storedKey) {
    checkLogin(storedNick, storedKey, true);
  } else {
    showLogin();
  }
};

function showLogin() {
  document.getElementById("loginScreen").style.display = "block";
  document.getElementById("mainScreen").style.display = "none";
}

function showMain(nick) {
  myNick = nick;
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainScreen").style.display = "block";
  document.getElementById("currentNick").textContent = `ë‹‰ë„¤ì„ : ${myNick}`;
}

window.tryLogin = () => {
  const nick = document.getElementById("nickInput").value.trim();
  const key = document.getElementById("codeInput").value.trim();
  if(!nick || !key) return alert("ë‹‰ë„¤ì„ê³¼ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  checkLogin(nick, key, false);
};

async function checkLogin(nick, key, isAuto) {
  const userRef = ref(db, `allowedUsers/${nick}`);
  const snap = await get(userRef);
  
  if (snap.exists() && snap.val().code === key) {
    localStorage.setItem("nickname", nick);
    localStorage.setItem("accessKey", key); 
    showMain(nick);
  } else {
    if(!isAuto) alert("âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‹‰ë„¤ì„ì´ê±°ë‚˜ ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    else showLogin();
  }
}

window.adminLogin = () => {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
  if(pw === ADMIN_PW) {
    alert("ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì…ì¥í•©ë‹ˆë‹¤.");
    localStorage.setItem("nickname", "ê´€ë¦¬ì");
    localStorage.setItem("accessKey", "ADMIN");
    showMain("ê´€ë¦¬ì");
    toggleAdmin(); 
  } else {
    alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
  }
};

function checkPW(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  if(pw !== ADMIN_PW) { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return false; }
  return true;
}

window.toggleAdmin = () => {
  const panel = document.getElementById("adminPanel");
  const btn = document.getElementById("adminBtn");
  if(!adminOpen){
    if(!checkPW()) return;
    panel.style.display="block";
    btn.textContent="âˆ’ ë‹«ê¸°";
    adminOpen=true;
    renderUserKeys(); 
  }else{
    panel.style.display="none";
    btn.textContent="+ ê´€ë¦¬ì";
    adminOpen=false;
  }
  renderRanking();
  renderAdminUserList(); 
  renderSuggestions(); 
};

window.issueKey = async () => {
  const nick = document.getElementById("newUserNick").value.trim();
  if(!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  await set(ref(db, `allowedUsers/${nick}`), { code: code, createdAt: Date.now() });
  document.getElementById("newUserNick").value = "";
  renderUserKeys();
};

window.deleteUserComplete = async (nick) => {
  if(!confirm(`ğŸš¨ ê²½ê³ : [${nick}] ë‹˜ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n1. ì ‘ì† í‚¤ ì‚­ì œ (ë¡œê·¸ì¸ ë¶ˆê°€)\n2. ì „ì /ë¡œê·¸ ì „ì²´ ì‚­ì œ\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

  await remove(ref(db, `allowedUsers/${nick}`));

  const logsRef = ref(db, "logs");
  const snapshot = await get(logsRef);
  if (snapshot.exists()) {
    const updates = {};
    const data = snapshot.val();
    let count = 0;
    Object.keys(data).forEach(key => {
      if (data[key].nick === nick) {
        updates[key] = null; 
        count++;
      }
    });
    if (count > 0) {
      await update(logsRef, updates);
    }
  }

  alert(`[${nick}] ë‹˜ì˜ í‚¤ì™€ ì „ì  ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
  renderUserKeys();
  renderRanking(); 
  renderAdminUserList(); 
};

function renderUserKeys() {
  const listDiv = document.getElementById("userKeyList");
  onValue(ref(db, "allowedUsers"), snap => {
    listDiv.innerHTML = "";
    const users = snap.val();
    if(!users) { listDiv.innerHTML = "<div style='color:rgba(255,255,255,0.4); text-align:center; padding:10px;'>ë°œê¸‰ëœ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }
    
    Object.entries(users).forEach(([nick, data]) => {
      const div = document.createElement("div");
      div.className = "key-row";
      div.innerHTML = `
        <div>
          <span style="color:var(--text-main); font-weight:bold;">${nick}</span>
          <span style="color:var(--accent); margin-left:10px; letter-spacing:2px;">${data.code}</span>
        </div>
        <button onclick="deleteUserComplete('${nick}')" style="background:#C62828; color:#fff; font-size:0.7rem; padding:4px 8px;">ì™„ì „ì‚­ì œ</button>
      `;
      listDiv.appendChild(div);
    });
  });
}

window.toggleDropdown = () => {
  const list = document.getElementById("defListDropdown");
  list.style.display = (list.style.display === "block") ? "none" : "block";
  if(list.style.display === "block"){
    document.getElementById("defSearchInput").value = "";
    filterDefense();
  }
};
window.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown-wrapper')) {
    document.getElementById("defListDropdown").style.display = "none";
  }
});

window.filterDefense = () => {
  const input = document.getElementById("defSearchInput");
  const filter = input.value.toLowerCase();
  const list = document.getElementById("defRealList");
  const items = list.getElementsByClassName("dropdown-item");

  for (let i = 0; i < items.length; i++) {
    const txt = items[i].textContent || items[i].innerText;
    if (txt.toLowerCase().indexOf(filter) > -1) {
      items[i].style.display = "";
    } else {
      items[i].style.display = "none";
    }
  }
};

/* ë°©ì–´íŒ€ ëª©ë¡ (ê²€ìƒ‰+ë¦¬ìŠ¤íŠ¸+ì¶”ê°€ë²„íŠ¼) */
onValue(ref(db,"defenseTeams"), snap => {
  const realList = document.getElementById("defRealList");
  const addBtnArea = document.getElementById("defAddBtnArea");
  
  realList.innerHTML = "";
  addBtnArea.innerHTML = "";
  
  defenseDataCache = snap.val() || {}; 
  
  // 1. ì‹¤ì œ ë¦¬ìŠ¤íŠ¸
  if(defenseDataCache) {
    Object.entries(defenseDataCache).forEach(([k, v]) => {
      const tWins = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.win||0),0);
      const tLose = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.lose||0),0);
      const rate = (tWins+tLose) ? Math.round(tWins/(tWins+tLose)*100) : 0;
      
      const div = document.createElement("div");
      div.className = "dropdown-item";
      div.innerHTML = `<b>${v.name}</b><small style="color:var(--text-sub); margin-left:5px;">${rate}% (${tWins}ìŠ¹ ${tLose}íŒ¨)</small>`;
      div.onclick = () => {
        document.getElementById("defCurrentText").innerHTML = `${v.name} <span style="font-size:0.8em; color:var(--text-sub);">(${rate}%)</span>`;
        document.getElementById("defListDropdown").style.display = "none";
        loadAttackTeams(k);
      };
      realList.appendChild(div);
    });
  } else {
    realList.innerHTML = "<div style='padding:15px; color:var(--text-sub); text-align:center;'>ë“±ë¡ëœ ë°©ì–´íŒ€ì´ ì—†ìŠµë‹ˆë‹¤</div>";
  }

  // 2. ì¶”ê°€ ë²„íŠ¼
  const addBtn = document.createElement("div");
  addBtn.className = "dropdown-item dropdown-add-btn";
  addBtn.innerHTML = "<b>ï¼‹ ìƒˆ ë°©ì–´íŒ€ ì¶”ê°€í•˜ê¸°</b>";
  addBtn.onclick = () => {
    const newName = prompt("ìƒˆë¡œ ì¶”ê°€í•  ë°©ì–´íŒ€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if(newName && newName.trim() !== "") {
      push(ref(db, "defenseTeams"), { name: newName.trim(), attackTeams: {} })
        .then(() => alert("ë°©ì–´íŒ€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."))
        .catch((err) => alert("ì˜¤ë¥˜: " + err));
      document.getElementById("defListDropdown").style.display = "none";
    }
  };
  addBtnArea.appendChild(addBtn);
});

window.loadAttackTeams = (dk) => {
  currentDefense = dk;
  currentAttack = ""; 
  document.getElementById("attackCard").style.display = "none";
  document.getElementById("suggestBtnArea").style.display = "block";
  const attackList = document.getElementById("attackList");
  attackList.innerHTML="";

  onValue(ref(db,`defenseTeams/${dk}/attackTeams`), snap => {
    attackList.innerHTML="";
    const d = snap.val(); if(!d) return;
    Object.entries(d).forEach(([ak, av]) => {
      const t = av.win + av.lose;
      const r = t ? Math.round(av.win/t*100) : 0;
      const b = document.createElement("button");
      b.className = "attack-btn";
      const fire = r >= 70 ? "<span style='color:#FF7043; text-shadow: 0 0 5px #FF7043;'>ğŸ”¥</span> " : "";
      b.innerHTML = `<b>${fire}${av.name}</b><small style="color:var(--text-sub);">${r}% (${av.win}ìŠ¹ ${av.lose}íŒ¨)</small>`;
      b.onclick = () => {
        document.querySelectorAll(".attack-btn").forEach(btn => btn.classList.remove("active"));
        b.classList.add("active");
        selectAttack(dk, ak);
      };
      attackList.appendChild(b);
    });
  });
  renderSuggestions(); 
};

/* ì œë³´ ê´€ë ¨ */
window.openSuggestModal = () => { document.getElementById("suggestModal").style.display = "flex"; };
window.closeSuggestModal = () => { document.getElementById("suggestModal").style.display = "none"; };

window.submitSuggestion = () => {
  if(!currentDefense) return alert("ë°©ì–´íŒ€ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  const name = document.getElementById("sugName").value;
  if(!name) return alert("ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

  const data = {
    name: name,
    type: document.getElementById("sugType").value,
    ring: document.getElementById("sugRing").value,
    pet: document.getElementById("sugPet").value, 
    armor: document.getElementById("sugArmor").value,
    skill: document.getElementById("sugSkill").value,
    suggester: myNick,
    timestamp: Date.now()
  };
  push(ref(db, `suggestions/${currentDefense}`), data).then(() => {
    alert("ì œë³´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë“±ë¡ë©ë‹ˆë‹¤.");
    closeSuggestModal();
    document.getElementById("sugName").value = "";
    document.getElementById("sugType").value = "";
    document.getElementById("sugRing").value = "";
    document.getElementById("sugPet").value = ""; 
    document.getElementById("sugArmor").value = "";
    document.getElementById("sugSkill").value = "";
  });
};

function renderSuggestions() {
  const listDiv = document.getElementById("suggestionList");
  onValue(ref(db, "suggestions"), snap => {
    listDiv.innerHTML = "";
    const allSugs = snap.val();
    if(!allSugs) { listDiv.innerHTML = "(ëŒ€ê¸° ì¤‘ì¸ ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤)"; return; }
    Object.entries(allSugs).forEach(([defKey, suggs]) => {
      const defName = defenseDataCache[defKey] ? defenseDataCache[defKey].name : "ì•Œìˆ˜ì—†ëŠ” ë°©ì–´íŒ€";
      Object.entries(suggs).forEach(([sugKey, data]) => {
        const div = document.createElement("div");
        div.className = "suggest-item";
        div.innerHTML = `
          <div style="font-weight:bold; color:var(--text-main); margin-bottom:5px;">[${defName}] ìƒëŒ€ë¡œ ì œë³´ë¨</div>
          <div style="margin-bottom:5px;"><span style="color:var(--accent); font-weight:bold;">${data.name}</span> <small style="color:var(--text-sub);">(by ${data.suggester})</small></div>
          <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:8px;">${data.type} / ${data.ring} / ${data.pet || '-'} / ${data.armor}</div>
          <div style="display:flex; gap:5px;">
            <button class="mini-btn bg-blue" onclick="approveSuggestion('${defKey}', '${sugKey}')">ìŠ¹ì¸</button>
            <button class="mini-btn bg-red" onclick="rejectSuggestion('${defKey}', '${sugKey}')">ê±°ì ˆ</button>
          </div>
        `;
        listDiv.appendChild(div);
      });
    });
  });
}

window.approveSuggestion = async (defKey, sugKey) => {
  if(!confirm("ì´ ë±ì„ ìŠ¹ì¸í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í• ê¹Œìš”?")) return;
  const snap = await get(ref(db, `suggestions/${defKey}/${sugKey}`));
  if(!snap.exists()) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
  const data = snap.val();
  const newAttack = {
    name: data.name, type: data.type, 
    ring: data.ring, pet: data.pet || "", 
    armor: data.armor, skill: data.skill,
    win: 0, lose: 0,
    maker: data.suggester 
  };
  await push(ref(db, `defenseTeams/${defKey}/attackTeams`), newAttack);
  await remove(ref(db, `suggestions/${defKey}/${sugKey}`));
  alert("ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

window.rejectSuggestion = async (defKey, sugKey) => {
  if(!confirm("ì •ë§ ê±°ì ˆí•˜ê³  ì‚­ì œí• ê¹Œìš”?")) return;
  await remove(ref(db, `suggestions/${defKey}/${sugKey}`));
  alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
};

/* ì¹´ë“œ ì¡°íšŒ ë° ë¡œì§ */
window.selectAttack = (dk, ak) => {
  currentAttack = ak;
  onValue(ref(db,`defenseTeams/${dk}/attackTeams/${ak}`), snap => {
    const d = snap.val(); if(!d) return;
    document.getElementById("attackCard").style.display = "block";
    document.getElementById("cardName").textContent = d.name;
    document.getElementById("cardMaker").textContent = d.maker ? `By. ${d.maker}` : "";
    
    document.getElementById("cardWin").textContent = d.win;
    document.getElementById("cardLose").textContent = d.lose;
    const total = d.win + d.lose;
    const rateVal = total ? Math.round(d.win / total * 100) : 0;
    document.getElementById("cardRate").textContent = rateVal;
    document.getElementById("cardFire").textContent = rateVal >= 70 ? "ğŸ”¥" : "";
    document.getElementById("cardType").textContent = d.type || "-";
    document.getElementById("cardRing").textContent = d.ring || "-";
    document.getElementById("cardPet").textContent = d.pet || "-"; 
    document.getElementById("cardArmor").innerHTML = (d.armor || "-").replace(/\n/g,"<br>");
    document.getElementById("cardSkill").textContent = d.skill || "-";
    loadRecentRecord(dk, ak);
    
    document.getElementById("atkName").value=d.name; 
    document.getElementById("atkType").value=d.type; 
    document.getElementById("ringRec").value=d.ring; 
    document.getElementById("atkPet").value=d.pet || ""; 
    document.getElementById("armorRec").value=d.armor; 
    document.getElementById("skillOrder").value=d.skill;
  });
};

async function loadRecentRecord(defenseKey, attackKey){
  const snap = await get(ref(db,"logs"));
  const recordDiv = document.getElementById("recentRecord");
  if(!snap.exists()) { recordDiv.innerHTML = "-"; return; }
  const logs = Object.values(snap.val()).filter(v => v.defense === defenseKey && v.attack === attackKey).sort((a,b)=>b.time-a.time).slice(0,5);
  let html = "";
  logs.forEach(v => { html += (v.result === "win" ? "<span style='color:#66BB6A;'>W</span> " : "<span style='color:#EF5350;'>L</span> "); });
  recordDiv.innerHTML = html || "-";
}

async function writeLog(result){
  if(!currentDefense || !currentAttack) return alert("âš ï¸ íŒ€ ì„ íƒ ì˜¤ë¥˜");
  const snap = await get(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`));
  if(!snap.exists()) { loadAttackTeams(currentDefense); return; }
  const atk = snap.val();
  set(push(ref(db,"logs")),{
    nick: myNick, result, defense: currentDefense, attack: currentAttack,
    attackName: atk.name || "", attackType: atk.type || "", date: new Date().toISOString().slice(0,10), time: Date.now()
  });
}

window.addWin = async () => {
  if(!currentDefense || !currentAttack) return alert("âš ï¸ ì„ íƒ í•„ìš”");
  if (!confirm(`ìŠ¹ë¦¬ ê¸°ë¡?`)) return;
  const w = +document.getElementById("cardWin").textContent;
  update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { win: w + 1 });
  writeLog("win");
};
window.addLose = async () => {
  if(!currentDefense || !currentAttack) return alert("âš ï¸ ì„ íƒ í•„ìš”");
  if (!confirm(`íŒ¨ë°° ê¸°ë¡?`)) return;
  const l = +document.getElementById("cardLose").textContent;
  update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { lose: l + 1 });
  writeLog("lose");
};
window.resetRecord = () => {
  if(!checkPW()) return;
  if(!currentAttack) return alert("ê³µê²©íŒ€ ì„ íƒ í•„ìš”");
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{win:0,lose:0});
};
window.addDefense = ()=>{ if(checkPW()) set(push(ref(db,"defenseTeams")),{name:document.getElementById("defName").value,attackTeams:{}}); };
window.delDefense = ()=>{ if(checkPW()) remove(ref(db,"defenseTeams/"+currentDefense)); };
window.addAttack = ()=>{
  if(!checkPW()) return;
  set(push(ref(db,`defenseTeams/${currentDefense}/attackTeams`)),{
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value, 
    ring:document.getElementById("ringRec").value, 
    pet:document.getElementById("atkPet").value, 
    armor:document.getElementById("armorRec").value, 
    skill:document.getElementById("skillOrder").value, win:0, lose:0
  });
};
window.editAttack = ()=>{
  if(!checkPW() || !currentAttack) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value, 
    ring:document.getElementById("ringRec").value, 
    pet:document.getElementById("atkPet").value, 
    armor:document.getElementById("armorRec").value, 
    skill:document.getElementById("skillOrder").value
  });
  alert("ìˆ˜ì •ì™„ë£Œ");
};
window.delAttack = ()=>{ if(checkPW() && currentAttack) remove(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`)); };

/* ë­í‚¹ & ìœ ì € ê´€ë¦¬ */
onValue(ref(db,"logs"), snap => { allLogsCache = snap.val() || {}; renderRanking(); if(adminOpen) renderAdminUserList(); });

function renderRanking() {
  const rankingList = document.getElementById("rankingList");
  const msg = document.getElementById("moreRankMsg");
  rankingList.innerHTML = "";

  if(!Object.keys(allLogsCache).length) {
    rankingList.innerHTML = "<div style='text-align:center; padding:10px; color:rgba(255,255,255,0.4);'>ê¸°ë¡ ì—†ìŒ</div>";
    document.getElementById("myStats").textContent = "ë‚´ ì „ì : ê¸°ë¡ ì—†ìŒ"; 
    return;
  }

  const userLogs = {};
  Object.values(allLogsCache).forEach(v => {
    if (!userLogs[v.nick]) userLogs[v.nick] = [];
    userLogs[v.nick].push(v);
  });

  const rankingData = Object.keys(userLogs).map(nick => {
    const logs = userLogs[nick];
    logs.sort((a, b) => b.time - a.time); // ìµœì‹ ìˆœ

    const totalWin = logs.filter(l => l.result === "win").length;
    const totalLose = logs.filter(l => l.result === "lose").length;
    
    // ìµœê·¼ 30íŒ
    const recentLogs = logs.slice(0, 30);
    const recentWin = recentLogs.filter(l => l.result === "win").length;
    const recentLose = recentLogs.filter(l => l.result === "lose").length;

    return { nick, totalWin, totalLose, recentWin, recentLose };
  });

  rankingData.sort((a, b) => b.totalWin - a.totalWin);

  const myData = rankingData.find(d => d.nick === myNick);
  const myStatDiv = document.getElementById("myStats");
  if(myData) {
    const myRankIndex = rankingData.indexOf(myData);
    const total = myData.totalWin + myData.totalLose;
    const rate = total ? Math.round(myData.totalWin / total * 100) : 0;
    myStatDiv.innerHTML = `ë‚´ ì „ì : ${myRankIndex + 1}ìœ„ / ${myData.totalWin}ìŠ¹ ${myData.totalLose}íŒ¨ (${rate}%)`;
    myStatDiv.style.color = "#B3E5FC";
  } else {
    myStatDiv.innerHTML = "ë‚´ ì „ì : ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"; 
    myStatDiv.style.color = "rgba(255,255,255,0.4)";
  }

  let hiddenCount = 0;
  rankingData.forEach((d, index) => {
    if(!adminOpen && index >= 10) { hiddenCount++; return; }

    let badge = ""; let nickStyle = "color:var(--text-main); font-weight:bold;";
    if(index === 0) { badge = "ğŸ¥‡"; nickStyle = "color:#FFD700; font-weight:bold; text-shadow: 0 0 10px #FFD700;"; }
    else if(index === 1) { badge = "ğŸ¥ˆ"; nickStyle = "color:#C0C0C0; font-weight:bold; text-shadow: 0 0 10px #C0C0C0;"; }
    else if(index === 2) { badge = "ğŸ¥‰"; nickStyle = "color:#CD7F32; font-weight:bold; text-shadow: 0 0 10px #CD7F32;"; }
    else { badge = `<span style='width:20px; display:inline-block; text-align:center; color:rgba(255,255,255,0.4);'>${index+1}</span>`; }

    const total = d.totalWin + d.totalLose;
    const winRate = total ? Math.round(d.totalWin / total * 100) : 0;

    // ìµœê·¼ 30íŒ ìŠ¹ë¥  ë° í¬ë§·íŒ…
    const rTotal = d.recentWin + d.recentLose;
    const rRate = rTotal ? Math.round(d.recentWin / rTotal * 100) : 0;
    const fire = (rTotal > 0 && rRate >= 70) ? "â˜ï¸" : "";
    const subInfoColor = fire ? "var(--text-sub)" : "rgba(255,255,255,0.4)"; 

    const div = document.createElement("div"); 
    div.className = "rank-row";
    if(adminOpen && index >= 10) div.style.background = "rgba(255,255,255,0.05)"; 

    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        ${badge} <span style="${nickStyle}">${d.nick}</span>
      </div>
      <div style="text-align:right;">
        <div style="color:var(--text-sub); font-size:0.95rem;">
          <span style="color:${d.totalWin>0?'#66BB6A':'var(--text-sub)'}">${d.totalWin}ìŠ¹</span> / ${d.totalLose}íŒ¨ (${winRate}%)
        </div>
        <div style="color:${subInfoColor}; font-size:0.75rem; margin-top:3px; letter-spacing:-0.5px;">
          (+${d.recentWin}w/${d.recentLose}l ${rRate}%${fire})
        </div>
      </div>
    `;
    rankingList.appendChild(div);
  });

  msg.style.display = hiddenCount > 0 ? "block" : "none";
}

window.adjustScore = async (nick, type, delta) => {
  if(delta === 1) {
    set(push(ref(db,"logs")),{
      nick: nick, result: type, defense: "admin", attack: "manual_adjust",
      attackName: "ê´€ë¦¬ììˆ˜ì •", attackType: "", date: new Date().toISOString().slice(0,10), time: Date.now()
    });
  } else {
    const snap = await get(ref(db, "logs"));
    if(!snap.exists()) return alert("ê¸°ë¡ ì—†ìŒ");
    const logs = Object.entries(snap.val()).map(([k,v]) => ({...v, key:k}))
      .filter(v => v.nick === nick && v.result === type).sort((a,b) => b.time - a.time);
    if(logs.length === 0) return alert("ê¸°ë¡ ì—†ìŒ");
    await remove(ref(db, `logs/${logs[0].key}`));
  }
};
function renderAdminUserList() {
  const listDiv = document.getElementById("adminUserList"); listDiv.innerHTML = "";
  const stat = {};
  Object.values(allLogsCache).forEach(v=>{
    if(!stat[v.nick]) stat[v.nick] = {w:0, l:0};
    if(v.result === "win") stat[v.nick].w++; else stat[v.nick].l++;
  });
  Object.keys(stat).sort().forEach(nick => {
    const val = stat[nick];
    const div = document.createElement("div");
    div.style.padding = "10px"; div.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
    div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.alignItems = "center";
    div.innerHTML = `
      <span style="font-weight:bold; width:80px; color:var(--text-main);">${nick}</span>
      <div style="display:flex; align-items:center; gap:5px;">
        <span style="color:#66BB6A; font-size:0.8rem;">ìŠ¹:${val.w}</span>
        <button class="mini-btn bg-blue" onclick="adjustScore('${nick}','win',1)">+</button>
        <button class="mini-btn bg-red" onclick="adjustScore('${nick}','win',-1)">-</button>
        <span style="color:#EF5350; font-size:0.8rem; margin-left:5px;">íŒ¨:${val.l}</span>
        <button class="mini-btn bg-blue" onclick="adjustScore('${nick}','lose',1)">+</button>
        <button class="mini-btn bg-red" onclick="adjustScore('${nick}','lose',-1)">-</button>
      </div>
    `;
    listDiv.appendChild(div);
  });
}
</script>
</body>
</html>
