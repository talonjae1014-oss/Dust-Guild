<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>â˜ï¸ ë¨¼ì§€ ê¸¸ë“œì „ (Deep Night)</title>
<style>
  /* --- [ìŠ¤íƒ€ì¼] Optimized Dark Theme (No Blur/Glass for Stability) --- */
  :root {
    --bg-color: #050510; /* ë‹¨ìƒ‰ ë°°ê²½ (ì•ˆì •ì„± ìµœìš°ì„ ) */
    --text-main: #FFFFFF;
    --text-sub: #D1D1D1;
    --accent: #B3E5FC; 
    --card-bg: #151520; /* ë¶ˆíˆ¬ëª… ë°°ê²½ */
    --card-border: #333;
    --card-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); /* ê·¸ë¦¼ì ë‹¨ìˆœí™” */
    --radius: 16px;
  }

  html, body {
    height: 100%;
    margin: 0; padding: 0;
    background-color: var(--bg-color);
    color: var(--text-main);
    font-family: 'Suit', sans-serif;
    overflow-x: hidden;
  }

  body {
    padding: 20px; 
    padding-bottom: 80px;
    box-sizing: border-box;
  }

  /* ë³„ ë°°ê²½: CSS ì—°ì‚° ìµœì†Œí™” */
  #starfield {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: -1;
    background: 
      radial-gradient(1px 1px at 25% 10%, #FFF, transparent),
      radial-gradient(1px 1px at 75% 20%, #FFF, transparent),
      radial-gradient(2px 2px at 50% 50%, #555, transparent),
      radial-gradient(1px 1px at 10% 80%, #FFF, transparent),
      radial-gradient(1px 1px at 90% 90%, #FFF, transparent);
    background-size: 500px 500px;
    opacity: 0.5;
  }

  h2, h3, h4 { margin-top: 0; color: var(--text-main); font-weight: 700; letter-spacing: -0.5px; }
  
  button {
    cursor: pointer; border: none; padding: 12px 18px; border-radius: 10px;
    font-weight: bold; transition: 0.2s; font-size: 0.9rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  button:active { transform: scale(0.98); }

  /* --- ê³µí†µ UI ìš”ì†Œ (ë¶ˆíˆ¬ëª…) --- */
  .flat-card {
    background: var(--card-bg); 
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
  }

  input, select, textarea {
    background: #0a0a10; /* ì•„ì£¼ ì–´ë‘ìš´ ë°°ê²½ */
    border: 1px solid #444; color: #FFF;
    padding: 14px; border-radius: 10px; width: 100%;
    box-sizing: border-box; margin-bottom: 8px;
    font-size: 0.95rem; outline: none;
    -webkit-appearance: none; /* iOS ìŠ¤íƒ€ì¼ ì œê±° */
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  
  /* --- ëŒ€ì‹œë³´ë“œ --- */
  #dashboardScreen { display: none; flex-direction: column; gap: 20px; max-width: 500px; margin: 0 auto; margin-top: 50px; }
  
  .dash-btn-big {
    background: #1565C0; color: #FFF; font-size: 1.5rem; height: 150px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    border: 1px solid #444;
  }
  .dash-btn-small {
    background: #37474F; color: #EEE; font-size: 1.1rem; height: 80px;
    border: 1px solid #444;
  }
  
  /* --- ë„¤ë¹„ê²Œì´ì…˜ --- */
  .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .back-btn { background: #333; color: #AAA; padding: 8px 12px; font-size: 0.8rem; }

  /* --- ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ --- */
  .grid-list {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px; margin-bottom: 20px;
  }
  .item-btn {
    background: #1e1e2d; border: 1px solid #333;
    color: var(--text-sub); padding: 15px 5px; border-radius: 12px;
    min-height: 85px; text-align: center;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    transition: 0.2s;
  }
  .item-btn.active {
    background: #1a2a40; border: 1px solid var(--accent);
    color: #FFF; font-weight: bold;
  }

  /* --- ìƒì„¸ ì •ë³´ ì¹´ë“œ --- */
  .detail-card {
    background: #151520; border: 1px solid #333;
    border-radius: var(--radius); padding: 25px; display: none; margin-bottom: 30px;
  }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
  .info-item { 
    background: #0a0a10; padding: 12px; border-radius: 8px; font-size: 0.9rem; 
    border: 1px solid #333; color: #EEE;
  }
  .info-item.full { grid-column: span 2; }
  .info-label { display: block; color: var(--accent); font-size: 0.75rem; margin-bottom: 5px; font-weight: bold; }

  /* --- ë“œë¡­ë‹¤ìš´ --- */
  .dropdown-list {
    display: none; position: absolute; top: 100%; left: 0; width: 100%; 
    z-index: 9999; /* ìµœìƒìœ„ ë³´ì¥ */
    background: #000; border: 1px solid #444; border-radius: var(--radius);
    margin-top: 8px; max-height: 400px; overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,1);
  }
  .dropdown-item { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; }

  /* --- ê´€ë¦¬ì íŒ¨ë„ --- */
  .admin-panel {
    background: #080808; /* ì™„ì „ ë¶ˆíˆ¬ëª… */
    border: 1px solid #444; padding: 20px; border-radius: 12px; 
    margin-top: 30px; display: none; position: relative; 
    z-index: 500;
  }
  .mini-btn { padding: 4px 8px; font-size: 0.75rem; margin-left: 2px; }
  .bg-blue { background: #1565C0; color: #FFF; }
  .bg-red { background: #C62828; color: #FFF; }

  /* --- ëª¨ë‹¬ --- */
  #modalOverlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); /* ì•„ì£¼ ì§„í•œ ë°°ê²½ */
    z-index: 10000;
    align-items: center; justify-content: center;
  }
  .modal-content {
    background: #151520; border: 1px solid var(--accent); 
    border-radius: var(--radius); padding: 25px; width: 90%; max-width: 400px;
  }

  footer {
    text-align: center; margin-top: 50px; padding: 20px;
    color: #555; font-size: 0.8rem; border-top: 1px solid #222;
  }
</style>
</head>
<body>

<div id="starfield"></div>

<div id="loginScreen" style="text-align:center; margin-top:100px;">
  <div style="font-size:3.5rem; margin-bottom:10px;">â˜ï¸</div>
  <h2 style="font-size:2.2rem; margin-bottom:30px; color:var(--text-main);">ë¨¼ì§€ ê¸¸ë“œì „</h2>
  
  <div class="flat-card" style="padding:30px; display:inline-block; width: 80%; max-width: 300px;">
    <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px; font-weight:bold;">ë¨¼ì§€ ê¸¸ë“œì „ ì…ì¥</p>
    <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„" style="text-align:center;">
    <input type="password" id="codeInput" placeholder="CODE (6ìë¦¬)" style="text-align:center; letter-spacing: 5px;">
    <button onclick="tryLogin()" style="width:100%; background:var(--accent); color:#02010a; margin-top:15px; font-size:1rem; padding:15px;">ì…ì¥í•˜ê¸°</button>
  </div>
  <div style="margin-top:40px;">
    <button onclick="adminLogin()" style="background:transparent; color:#555; font-size:0.8rem;">[ ê´€ë¦¬ì ì „ìš© ]</button>
  </div>
</div>

<div id="dashboardScreen">
  <div style="text-align:center; margin-bottom:10px;">
    <h3 id="dashNick" style="color:var(--accent);">í™˜ì˜í•©ë‹ˆë‹¤</h3>
  </div>
  
  <button class="dash-btn-big" onclick="goAttackMode()">
    <div style="font-size:2.5rem; margin-bottom:10px;">âš”ï¸</div>
    ê¸¸ë“œì „ ê³µê²©í•˜ê¸°
  </button>
  
  <button class="dash-btn-small" onclick="goDefenseMode()">
    ğŸ›¡ï¸ ì¶”ì²œ ë°©ì–´íŒ€ ë³´ê¸°
  </button>
</div>

<div id="attackScreen" style="display:none; max-width: 600px; margin: 0 auto;">
  <div class="nav-header">
    <button class="back-btn" onclick="goDashboard()">â—€ í™ˆìœ¼ë¡œ</button>
    <button onclick="toggleAttackAdmin()" id="atkAdminBtn" style="background:#222; color:#AAA; font-size:0.8rem; padding:6px 12px;">+ ê´€ë¦¬ì</button>
  </div>

  <div style="margin-bottom:20px;">
    <div id="myStats" style="color:var(--text-sub); font-size:0.85rem;">ë‚´ ì „ì  ë¡œë”©ì¤‘...</div>
  </div>

  <div style="position:relative; margin-bottom:25px; z-index:1000;">
    <div class="flat-card" onclick="toggleDefDropdown()" style="padding:15px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
      <span id="defCurrentText" style="font-weight:bold;">ğŸ›¡ï¸ ë°©ì–´íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
      <span style="color:var(--accent);">â–¼</span>
    </div>
    <div id="defListDropdown" class="dropdown-list">
      <div style="padding:10px; background:#000; position:sticky; top:0;">
        <input type="text" id="defSearchInput" placeholder="ğŸ” ê²€ìƒ‰..." oninput="filterDefense()" onclick="event.stopPropagation()">
      </div>
      <div id="defRealList"></div>
      <div id="defAddBtnArea"></div>
    </div>
  </div>

  <div id="attackList" class="grid-list"></div>
  
  <div id="atkSuggestBtn" style="text-align:center; margin-bottom:20px; display:none;">
    <button onclick="openModal('attack')" style="background:#111; border:1px dashed #444; color:#888; width:100%; padding:15px;">+ ê³µê²©ë± ì œë³´í•˜ê¸°</button>
  </div>

  <div id="attackCard" class="detail-card">
    <h2 style="border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:10px;">
      <span id="cardFire"></span> <span id="cardName"></span>
      <span style="float:right; font-size:0.6em; color:#888; font-weight:normal;">ìŠ¹ë¥  <span id="cardRate" style="color:var(--accent); font-size:1.4em;">0</span>%</span>
      <div id="cardMaker" style="font-size:0.4em; color:#666; font-weight:normal; margin-top:5px;"></div>
    </h2>
    <div class="info-grid">
      <div class="info-item"><span class="info-label">ì „ì </span><span id="cardWin">0</span>ìŠ¹ <span id="cardLose">0</span>íŒ¨</div>
      <div class="info-item"><span class="info-label">ì†ê³µ</span><span id="cardType">-</span></div>
      <div class="info-item"><span class="info-label">ë°˜ì§€</span><span id="cardRing">-</span></div>
      <div class="info-item"><span class="info-label">í«</span><span id="cardPet">-</span></div>
      <div class="info-item full"><span class="info-label">ìŠ¤í‚¬ìˆœì„œ</span><span id="cardSkill">-</span></div>
      <div class="info-item full"><span class="info-label">ì¥ë¹„ì„¸íŒ… ë° íŠ¹ì´ì‚¬í•­</span><span id="cardArmor">-</span></div>
      <div class="info-item full"><span class="info-label">ìµœê·¼ 5ê²½ê¸°</span><div id="recentRecord" style="letter-spacing:3px;">-</div></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button onclick="addWin()" style="background:#1b5e20; color:#fff; width:48%; padding:15px;">ğŸ† ìŠ¹ë¦¬</button>
      <button onclick="addLose()" style="background:#b71c1c; color:#fff; width:48%; padding:15px;">ğŸ’€ íŒ¨ë°°</button>
    </div>
    <div style="text-align:right; margin-top:10px;">
       <button onclick="resetRecord()" style="background:transparent; color:#555; font-size:0.8rem; text-decoration:underline;">[ê´€ë¦¬ì] ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div style="margin-top:40px; border-top:1px solid #333; padding-top:20px;">
    <h3 style="font-size:1rem; color:#AAA;">â˜ï¸ ëª…ì˜ˆì˜ ì „ë‹¹</h3>
    <div id="rankingList" class="flat-card" style="padding:0; overflow:hidden; background:#111;"></div>
    <div id="moreRankMsg" style="text-align:center; color:#555; font-size:0.8rem; margin-top:10px; display:none;">* 11ìœ„ ì´í•˜ëŠ” ê´€ë¦¬ìì—ê²Œë§Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>

  <div id="attackAdminPanel" class="admin-panel">
    <h4 style="color:#FFF;">ğŸ› ï¸ ê³µê²© ê´€ë¦¬ì</h4>
    <div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
      <div style="color:#EF5350; margin-bottom:5px;">ğŸ”” ê³µê²©ë± ì œë³´ ê´€ë¦¬</div>
      <div id="atkSuggestionList" style="color:#888; font-size:0.9rem;">(ì œë³´ ì—†ìŒ)</div>
    </div>
    <div style="margin-bottom:20px;">
      <div style="color:#B3E5FC; margin-bottom:5px;">ğŸ›¡ï¸ ë°©ì–´íŒ€ ê´€ë¦¬</div>
      <input type="text" id="newDefName" placeholder="ìƒˆ ë°©ì–´íŒ€ ì´ë¦„">
      <button onclick="addDefense()" class="bg-blue">ì¶”ê°€</button>
      <button onclick="delDefense()" class="bg-red">í˜„ì¬ ë°©ì–´íŒ€ ì‚­ì œ</button>
    </div>
    <div style="margin-bottom:20px;">
      <div style="color:#B3E5FC; margin-bottom:5px;">âš”ï¸ ê³µê²©íŒ€ ì§ì ‘ ê´€ë¦¬</div>
      <input type="text" id="atkName" placeholder="ê³µê²©íŒ€ ì´ë¦„">
      <select id="atkType">
        <option value="" disabled selected>ì†ê³µ ì„ íƒ</option>
        <option value="ì†ê³µ ë”°ì•¼ í•¨">âš¡ ì†ê³µ ë”°ì•¼ í•¨</option>
        <option value="ë‚´ì¤˜ë„ ë¨">ğŸ›¡ï¸ ë‚´ì¤˜ë„ ë¨</option>
      </select>
      <input type="text" id="ringRec" placeholder="ë°˜ì§€">
      <input type="text" id="atkPet" placeholder="í«">
      <textarea id="armorRec" rows="2" placeholder="ì¥ë¹„/íŠ¹ì´ì‚¬í•­"></textarea>
      <input type="text" id="skillOrder" placeholder="ìŠ¤í‚¬">
      <div style="margin-top:5px;">
        <button onclick="addAttack()" class="bg-blue">ì¶”ê°€</button>
        <button onclick="editAttack()" class="bg-blue">ìˆ˜ì •</button>
        <button onclick="delAttack()" class="bg-red">ì‚­ì œ</button>
      </div>
    </div>
    <div>
      <div style="color:#B3E5FC; margin-bottom:5px;">ğŸ”‘ ê¸¸ë“œì› ì…ì¥ì½”ë“œ ê´€ë¦¬</div>
      <div style="display:flex; gap:5px; margin-bottom:5px;">
        <input type="text" id="newUserNick" placeholder="ë‹‰ë„¤ì„">
        <button onclick="issueKey()" style="background:#2E7D32; color:#fff; width:60px;">ë°œê¸‰</button>
      </div>
      <div id="userKeyList" style="max-height:150px; overflow-y:auto;"></div>
      <div id="adminUserList" style="max-height:200px; overflow-y:auto; margin-top:10px; border-top:1px solid #333;"></div>
    </div>
  </div>
</div>

<div id="defenseScreen" style="display:none; max-width: 600px; margin: 0 auto;">
  <div class="nav-header">
    <button class="back-btn" onclick="goDashboard()">â—€ í™ˆìœ¼ë¡œ</button>
    <button onclick="toggleDefenseAdmin()" id="defAdminBtn" style="background:#222; color:#AAA; font-size:0.8rem; padding:6px 12px;">+ ê´€ë¦¬ì</button>
  </div>

  <h3 style="text-align:center; color:var(--accent); margin-bottom:20px;">â­ï¸ ì¶”ì²œ ë°©ì–´íŒ€ ëª©ë¡ â­ï¸</h3>
  
  <div id="recDefList" class="grid-list"></div>

  <div style="text-align:center; margin-top:30px;">
    <button onclick="openModal('defense')" style="background:#111; border:1px dashed #444; color:#888; width:100%; padding:15px;">+ ë‚´ ë°©ì–´ë± ì œë³´í•˜ê¸°</button>
  </div>

  <div id="recDefCard" class="detail-card">
    <h2 style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
      <span id="rdName"></span>
      <div id="rdMaker" style="font-size:0.4em; color:#666; font-weight:normal;"></div>
    </h2>
    <div class="info-grid">
      <div class="info-item full"><span class="info-label">ë°˜ì§€ ì¶”ì²œ</span><span id="rdHeroes">-</span></div>
      <div class="info-item"><span class="info-label">ì§„í˜•</span><span id="rdFormation">-</span></div>
      <div class="info-item"><span class="info-label">í«</span><span id="rdPet">-</span></div>
      <div class="info-item full"><span class="info-label">ì„¤ëª… ë° íŒ</span><span id="rdDesc">-</span></div>
    </div>
  </div>

  <div id="defenseAdminPanel" class="admin-panel">
    <h4 style="color:#FFF;">ğŸ› ï¸ ë°©ì–´íŒ€ ê´€ë¦¬ì</h4>
    <div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
      <div style="color:#EF5350; margin-bottom:5px;">ğŸ”” ë°©ì–´ë± ì œë³´ ê´€ë¦¬</div>
      <div id="defSuggestionList" style="color:#888; font-size:0.9rem;">(ì œë³´ ì—†ìŒ)</div>
    </div>
    <div>
      <div style="color:#B3E5FC; margin-bottom:5px;">ğŸ“ ì¶”ì²œ ë°©ì–´íŒ€ ì§ì ‘ ì¶”ê°€</div>
      <input type="text" id="rdInputName" placeholder="ë°©ì–´íŒ€ ì´ë¦„ (ì˜ˆ: ë©”íƒ€ 1ë²ˆ)">
      <input type="text" id="rdInputHeroes" placeholder="ë°˜ì§€ ì¶”ì²œ">
      <input type="text" id="rdInputFormation" placeholder="ì§„í˜•">
      <input type="text" id="rdInputPet" placeholder="í«">
      <textarea id="rdInputDesc" rows="2" placeholder="ì„¤ëª…"></textarea>
      <div style="margin-top:5px;">
        <button onclick="addRecDefense()" class="bg-blue">ì¶”ê°€</button>
        <button onclick="editRecDefense()" class="bg-blue">ìˆ˜ì • ì €ì¥</button>
        <button onclick="delRecDefense()" class="bg-red">ì‚­ì œ</button>
      </div>
    </div>
  </div>
</div>

<div id="modalOverlay">
  <div class="modal-content">
    <h3 id="modalTitle" style="color:var(--text-main); margin-bottom:15px;">ì œë³´í•˜ê¸°</h3>
    <div id="modalBody"></div>
    <div style="display:flex; gap:10px; margin-top:15px;">
      <button id="modalSubmitBtn" style="flex:1; background:var(--accent); color:#000;">ì œë³´</button>
      <button onclick="closeModal()" style="flex:1; background:#333; color:#fff;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<footer>
  <div style="margin-bottom:5px;">Designed & Developed by <b>ë¨¼ì§€</b></div>
  <div style="font-size:0.7rem;">Copyright Â© 2024 Dust Guild. All rights reserved.</div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update, push, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCZHWLw-qci0WoRiSxviEV4rTtGXyiF6Mo",
  authDomain: "dust-guild.firebaseapp.com",
  databaseURL: "https://dust-guild-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dust-guild",
  storageBucket: "dust-guild.firebasestorage.app",
  messagingSenderId: "735022364594",
  appId: "1:735022364594:web:a4ba424b06f90c1b9b56ab"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const ADMIN_PW = "0918";

let myNick = "";
let currentDefense = ""; 
let currentAttack = ""; 
let currentRecDef = ""; 
let adminOpen = false;
let isAdminAuthenticated = false; 

let allLogsCache = []; 
let defenseDataCache = {}; 

window.onload = () => {
  const storedNick = localStorage.getItem("nickname");
  const storedKey = localStorage.getItem("accessKey");
  if (storedNick && storedKey) {
    if(storedNick === "ê´€ë¦¬ì" && storedKey === "ADMIN") isAdminAuthenticated = true;
    checkLogin(storedNick, storedKey, true);
  } else {
    showLogin();
  }
};

/* --- í™”ë©´ ì „í™˜ ë¡œì§ --- */
function showLogin() {
  document.getElementById("loginScreen").style.display = "block";
  document.getElementById("dashboardScreen").style.display = "none";
  document.getElementById("attackScreen").style.display = "none";
  document.getElementById("defenseScreen").style.display = "none";
}

function showDashboard() {
  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("dashboardScreen").style.display = "flex";
  document.getElementById("attackScreen").style.display = "none";
  document.getElementById("defenseScreen").style.display = "none";
  document.getElementById("dashNick").textContent = `${myNick}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤`;
}

window.goDashboard = showDashboard;

window.goAttackMode = () => {
  document.getElementById("dashboardScreen").style.display = "none";
  document.getElementById("attackScreen").style.display = "block";
  document.getElementById("currentNick").textContent = `ë‹‰ë„¤ì„ : ${myNick}`;
};

window.goDefenseMode = () => {
  document.getElementById("dashboardScreen").style.display = "none";
  document.getElementById("defenseScreen").style.display = "block";
  loadRecDefenseList(); 
};

/* --- ë¡œê·¸ì¸ ë¡œì§ --- */
window.tryLogin = () => {
  const nick = document.getElementById("nickInput").value.trim();
  const key = document.getElementById("codeInput").value.trim();
  if(!nick || !key) return alert("ì…ë ¥í•´ì£¼ì„¸ìš”.");
  checkLogin(nick, key, false);
};

async function checkLogin(nick, key, isAuto) {
  const userRef = ref(db, `allowedUsers/${nick}`);
  const snap = await get(userRef);
  if (snap.exists() && snap.val().code === key) {
    localStorage.setItem("nickname", nick);
    localStorage.setItem("accessKey", key); 
    myNick = nick;
    showDashboard();
  } else {
    if(!isAuto) alert("ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    else showLogin();
  }
}

window.adminLogin = () => {
  if(prompt("ë¹„ë°€ë²ˆí˜¸") === ADMIN_PW) {
    localStorage.setItem("nickname", "ê´€ë¦¬ì");
    localStorage.setItem("accessKey", "ADMIN");
    myNick = "ê´€ë¦¬ì";
    isAdminAuthenticated = true; 
    showDashboard();
  } else { alert("ì˜¤ë¥˜"); }
};

function checkPW() { 
  if(isAdminAuthenticated) return true; 
  if(prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸") === ADMIN_PW) {
    isAdminAuthenticated = true; 
    return true;
  }
  return false;
}

/* --- [ê³µê²© ëª¨ë“œ] ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ --- */
window.toggleAttackAdmin = () => {
  const panel = document.getElementById("attackAdminPanel");
  if(panel.style.display === "none") {
    if(!checkPW()) return; 
    panel.style.display = "block";
    renderUserKeys();
    renderAtkSuggestions();
    renderAdminUserList();
  } else {
    panel.style.display = "none";
  }
  renderRanking(); 
};

window.toggleDefDropdown = () => {
  const list = document.getElementById("defListDropdown");
  list.style.display = (list.style.display === "block") ? "none" : "block";
  if(list.style.display==="block") {
    document.getElementById("defSearchInput").value="";
    filterDefense();
  }
};
window.addEventListener('click', (e) => {
  if (!e.target.closest('.flat-card') && !e.target.closest('.dropdown-list')) {
    document.getElementById("defListDropdown").style.display = "none";
  }
});

onValue(ref(db,"defenseTeams"), snap => {
  const realList = document.getElementById("defRealList");
  realList.innerHTML = "";
  defenseDataCache = snap.val() || {};
  if(defenseDataCache) {
    Object.entries(defenseDataCache).forEach(([k, v]) => {
      const tWins = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.win||0),0);
      const tLose = Object.values(v.attackTeams||{}).reduce((a,b)=>a+(b.lose||0),0);
      const rate = (tWins+tLose) ? Math.round(tWins/(tWins+tLose)*100) : 0;
      const div = document.createElement("div");
      div.className = "dropdown-item";
      div.innerHTML = `<b>${v.name}</b> <small style="color:#888;">${rate}%</small>`;
      div.onclick = () => {
        document.getElementById("defCurrentText").textContent = v.name;
        document.getElementById("defListDropdown").style.display = "none";
        loadAttackTeams(k);
      };
      realList.appendChild(div);
    });
  }
});

window.filterDefense = () => {
  const filter = document.getElementById("defSearchInput").value.toLowerCase();
  const items = document.getElementById("defRealList").children;
  for(let item of items) {
    item.style.display = item.textContent.toLowerCase().includes(filter) ? "" : "none";
  }
};

window.loadAttackTeams = (dk) => {
  currentDefense = dk; currentAttack = "";
  document.getElementById("attackCard").style.display = "none";
  document.getElementById("atkSuggestBtn").style.display = "block";
  
  // [ì¶”ê°€] ë°©ì–´íŒ€ ë³€ê²½ ì‹œ ê´€ë¦¬ì ì…ë ¥ì°½ ì´ˆê¸°í™”
  document.getElementById("atkName").value = "";
  document.getElementById("atkType").value = "";
  document.getElementById("ringRec").value = "";
  document.getElementById("atkPet").value = "";
  document.getElementById("armorRec").value = "";
  document.getElementById("skillOrder").value = "";

  const list = document.getElementById("attackList");
  list.innerHTML = "";
  
  onValue(ref(db,`defenseTeams/${dk}/attackTeams`), snap => {
    list.innerHTML = "";
    const d = snap.val(); if(!d) return;
    Object.entries(d).forEach(([ak, av]) => {
      const t = av.win + av.lose;
      const r = t ? Math.round(av.win/t*100) : 0;
      const b = document.createElement("div");
      b.className = "item-btn";
      const fire = r >= 70 ? "<span style='color:#FF7043'>ğŸ”¥</span>" : "";
      b.innerHTML = `<div>${fire} ${av.name}</div><div style="font-size:0.8rem; color:#888;">${r}% (${av.win}ìŠ¹)</div>`;
      b.onclick = () => {
        document.querySelectorAll("#attackList .item-btn").forEach(x => x.classList.remove("active"));
        b.classList.add("active");
        selectAttack(dk, ak);
      };
      list.appendChild(b);
    });
  });
  renderAtkSuggestions();
};

window.selectAttack = (dk, ak) => {
  currentAttack = ak;
  onValue(ref(db,`defenseTeams/${dk}/attackTeams/${ak}`), snap => {
    const d = snap.val(); if(!d) return;
    document.getElementById("attackCard").style.display = "block";
    document.getElementById("cardName").textContent = d.name;
    document.getElementById("cardMaker").textContent = d.maker ? `By. ${d.maker}` : "";
    document.getElementById("cardWin").textContent = d.win;
    document.getElementById("cardLose").textContent = d.lose;
    const total = d.win + d.lose;
    const r = total ? Math.round(d.win/total*100) : 0;
    document.getElementById("cardRate").textContent = r;
    document.getElementById("cardFire").textContent = r>=70 ? "ğŸ”¥" : "";
    document.getElementById("cardType").textContent = d.type || "-";
    document.getElementById("cardRing").textContent = d.ring || "-";
    document.getElementById("cardPet").textContent = d.pet || "-";
    document.getElementById("cardArmor").textContent = d.armor || "-";
    document.getElementById("cardSkill").textContent = d.skill || "-";
    loadRecentRecord(dk, ak);

    // ê´€ë¦¬ì ìˆ˜ì •ìš© ê°’ ì±„ìš°ê¸°
    document.getElementById("atkName").value = d.name;
    document.getElementById("atkType").value = d.type;
    document.getElementById("ringRec").value = d.ring;
    document.getElementById("atkPet").value = d.pet||"";
    document.getElementById("armorRec").value = d.armor;
    document.getElementById("skillOrder").value = d.skill;
  });
};

async function loadRecentRecord(dk, ak){
  const snap = await get(ref(db,"logs"));
  const div = document.getElementById("recentRecord");
  if(!snap.exists()) { div.innerHTML="-"; return; }
  const logs = Object.values(snap.val()).filter(v => v.defense===dk && v.attack===ak).sort((a,b)=>b.time-a.time).slice(0,5);
  let html="";
  logs.forEach(v => { html += (v.result==="win" ? "<span style='color:#4caf50'>W</span> " : "<span style='color:#f44336'>L</span> "); });
  div.innerHTML = html || "-";
}

async function writeLog(res){
  if(!currentDefense || !currentAttack) return;
  const snap = await get(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`));
  const atk = snap.val();
  push(ref(db,"logs"), {
    nick:myNick, result:res, defense:currentDefense, attack:currentAttack,
    attackName:atk.name, attackType:atk.type, date:new Date().toISOString().slice(0,10), time:Date.now()
  });
}
window.addWin = async () => {
  if(!confirm("ìŠ¹ë¦¬ ê¸°ë¡?")) return;
  const w = +document.getElementById("cardWin").textContent;
  await update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { win:w+1 });
  writeLog("win");
};
window.addLose = async () => {
  if(!confirm("íŒ¨ë°° ê¸°ë¡?")) return;
  const l = +document.getElementById("cardLose").textContent;
  await update(ref(db, `defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), { lose:l+1 });
  writeLog("lose");
};
window.resetRecord = () => {
  if(checkPW()) update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`),{win:0,lose:0});
};

window.addDefense = ()=>{ if(checkPW()) push(ref(db,"defenseTeams"),{name:document.getElementById("newDefName").value,attackTeams:{}}); };
window.delDefense = ()=>{ if(checkPW()) remove(ref(db,"defenseTeams/"+currentDefense)); };
window.addAttack = ()=>{
  if(!checkPW()) return;
  push(ref(db,`defenseTeams/${currentDefense}/attackTeams`), {
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value,
    ring:document.getElementById("ringRec").value, pet:document.getElementById("atkPet").value,
    armor:document.getElementById("armorRec").value, skill:document.getElementById("skillOrder").value, win:0, lose:0
  });
};
window.editAttack = ()=>{
  if(!checkPW() || !currentAttack) return;
  update(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`), {
    name:document.getElementById("atkName").value, type:document.getElementById("atkType").value,
    ring:document.getElementById("ringRec").value, pet:document.getElementById("atkPet").value,
    armor:document.getElementById("armorRec").value, skill:document.getElementById("skillOrder").value
  });
  alert("ìˆ˜ì •ë¨");
};
window.delAttack = ()=>{ if(checkPW()) remove(ref(db,`defenseTeams/${currentDefense}/attackTeams/${currentAttack}`)); };

function renderAtkSuggestions() {
  const div = document.getElementById("atkSuggestionList");
  onValue(ref(db, "suggestions/attack"), snap => {
    div.innerHTML = "";
    const all = snap.val();
    if(!all) { div.innerHTML="(ì—†ìŒ)"; return; }
    Object.entries(all).forEach(([dk, sub]) => {
      const dName = defenseDataCache[dk]?.name || "ì‚­ì œëœë°©ì–´íŒ€";
      Object.entries(sub).forEach(([sk, v]) => {
        const d = document.createElement("div");
        d.style.marginBottom="10px"; d.style.borderBottom="1px solid #333";
        d.innerHTML = `
          <div style="color:#FFF">[${dName}] ${v.name}</div>
          <div style="font-size:0.8rem">${v.suggester}</div>
          <button class="mini-btn bg-blue" onclick="approveAtk('${dk}','${sk}')">ìŠ¹ì¸</button>
          <button class="mini-btn bg-red" onclick="rejectAtk('${dk}','${sk}')">ê±°ì ˆ</button>
        `;
        div.appendChild(d);
      });
    });
  });
}
window.approveAtk = async (dk, sk) => {
  if(!confirm("ìŠ¹ì¸?")) return;
  const snap = await get(ref(db, `suggestions/attack/${dk}/${sk}`));
  const d = snap.val();
  await push(ref(db, `defenseTeams/${dk}/attackTeams`), {
    name:d.name, type:d.type, ring:d.ring, pet:d.pet, armor:d.armor, skill:d.skill, win:0, lose:0, maker:d.suggester
  });
  await remove(ref(db, `suggestions/attack/${dk}/${sk}`));
};
window.rejectAtk = (dk,sk) => { if(confirm("ê±°ì ˆ?")) remove(ref(db, `suggestions/attack/${dk}/${sk}`)); };


/* --- [ë°©ì–´ ëª¨ë“œ] ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ --- */
window.toggleDefenseAdmin = () => {
  const panel = document.getElementById("defenseAdminPanel");
  if(panel.style.display === "none") {
    if(!checkPW()) return;
    panel.style.display = "block";
    renderDefSuggestions();
  } else {
    panel.style.display = "none";
  }
};

window.loadRecDefenseList = () => {
  const list = document.getElementById("recDefList");
  onValue(ref(db, "recommendedDefenses"), snap => {
    list.innerHTML = "";
    document.getElementById("recDefCard").style.display = "none";
    const data = snap.val();
    if(!data) { list.innerHTML = "<div style='color:#555;'>ë“±ë¡ëœ ì¶”ì²œ ë°©ì–´íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }
    
    Object.entries(data).forEach(([key, val]) => {
      const div = document.createElement("div");
      div.className = "item-btn";
      div.innerHTML = `<div style="font-weight:bold; color:#FFF;">${val.name}</div>`;
      div.onclick = () => {
        document.querySelectorAll("#recDefList .item-btn").forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
        showRecDefDetail(key, val);
      };
      list.appendChild(div);
    });
  });
};

function showRecDefDetail(key, val) {
  currentRecDef = key;
  document.getElementById("recDefCard").style.display = "block";
  document.getElementById("rdName").textContent = val.name;
  document.getElementById("rdMaker").textContent = val.maker ? `By. ${val.maker}` : "";
  document.getElementById("rdHeroes").textContent = val.heroes || "-";
  document.getElementById("rdFormation").textContent = val.formation || "-";
  document.getElementById("rdPet").textContent = val.pet || "-";
  document.getElementById("rdDesc").innerHTML = (val.desc || "-").replace(/\n/g,"<br>");

  document.getElementById("rdInputName").value = val.name;
  document.getElementById("rdInputHeroes").value = val.heroes;
  document.getElementById("rdInputFormation").value = val.formation;
  document.getElementById("rdInputPet").value = val.pet;
  document.getElementById("rdInputDesc").value = val.desc;
}

window.addRecDefense = () => {
  if(!checkPW()) return;
  push(ref(db, "recommendedDefenses"), {
    name: document.getElementById("rdInputName").value,
    heroes: document.getElementById("rdInputHeroes").value,
    formation: document.getElementById("rdInputFormation").value,
    pet: document.getElementById("rdInputPet").value,
    desc: document.getElementById("rdInputDesc").value,
    maker: "ê´€ë¦¬ì"
  });
};
window.editRecDefense = () => {
  if(!checkPW() || !currentRecDef) return;
  update(ref(db, `recommendedDefenses/${currentRecDef}`), {
    name: document.getElementById("rdInputName").value,
    heroes: document.getElementById("rdInputHeroes").value,
    formation: document.getElementById("rdInputFormation").value,
    pet: document.getElementById("rdInputPet").value,
    desc: document.getElementById("rdInputDesc").value
  });
  alert("ìˆ˜ì •ë¨");
};
window.delRecDefense = () => {
  if(!checkPW() || !currentRecDef) return;
  if(confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) remove(ref(db, `recommendedDefenses/${currentRecDef}`));
};

function renderDefSuggestions() {
  const div = document.getElementById("defSuggestionList");
  onValue(ref(db, "suggestions/defense"), snap => {
    div.innerHTML = "";
    const all = snap.val();
    if(!all) { div.innerHTML="(ì—†ìŒ)"; return; }
    Object.entries(all).forEach(([k, v]) => {
      const d = document.createElement("div");
      d.style.marginBottom="10px"; d.style.borderBottom="1px solid #333";
      d.innerHTML = `
        <div style="color:#FFF">${v.name}</div>
        <div style="font-size:0.8rem">${v.heroes} / ${v.suggester}</div>
        <button class="mini-btn bg-blue" onclick="approveDef('${k}')">ìŠ¹ì¸</button>
        <button class="mini-btn bg-red" onclick="rejectDef('${k}')">ê±°ì ˆ</button>
      `;
      div.appendChild(d);
    });
  });
}
window.approveDef = async (key) => {
  if(!confirm("ìŠ¹ì¸?")) return;
  const snap = await get(ref(db, `suggestions/defense/${key}`));
  const d = snap.val();
  await push(ref(db, "recommendedDefenses"), {
    name:d.name, heroes:d.heroes, formation:d.formation, pet:d.pet, desc:d.desc, maker:d.suggester
  });
  await remove(ref(db, `suggestions/defense/${key}`));
};
window.rejectDef = (key) => { if(confirm("ê±°ì ˆ?")) remove(ref(db, `suggestions/defense/${key}`)); };


/* --- ëª¨ë‹¬ ê³µí†µ --- */
let modalType = ""; 
window.openModal = (type) => {
  modalType = type;
  document.getElementById("modalOverlay").style.display = "flex";
  const body = document.getElementById("modalBody");
  
  if(type === 'attack') {
    if(!currentDefense) { alert("ë°©ì–´íŒ€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); closeModal(); return; }
    document.getElementById("modalTitle").textContent = "ê³µê²©ë± ì œë³´";
    // [ë³€ê²½] íƒ€ì… -> ì†ê³µ
    body.innerHTML = `
      <input id="mName" placeholder="ê³µê²©íŒ€ ì´ë¦„ (í•„ìˆ˜)">
      <select id="mType"><option value="ì†ê³µ ë”°ì•¼ í•¨">âš¡ ì†ê³µ ë”°ì•¼ í•¨</option><option value="ë‚´ì¤˜ë„ ë¨">ğŸ›¡ï¸ ë‚´ì¤˜ë„ ë¨</option></select>
      <input id="mRing" placeholder="ë°˜ì§€">
      <input id="mPet" placeholder="í«">
      <textarea id="mArmor" rows="2" placeholder="ì¥ë¹„/íŠ¹ì´ì‚¬í•­"></textarea>
      <input id="mSkill" placeholder="ìŠ¤í‚¬ìˆœì„œ">
    `;
    document.getElementById("modalSubmitBtn").onclick = submitAttackSug;
  } else {
    document.getElementById("modalTitle").textContent = "ë°©ì–´ë± ì œë³´";
    body.innerHTML = `
      <input id="mDefName" placeholder="ë°©ì–´íŒ€ ì´ë¦„ (í•„ìˆ˜)">
      <input id="mHeroes" placeholder="ë°˜ì§€ ì¶”ì²œ">
      <input id="mForm" placeholder="ì§„í˜•">
      <input id="mPet" placeholder="í«">
      <textarea id="mDesc" rows="3" placeholder="ì„¤ëª… ë° íŒ"></textarea>
    `;
    document.getElementById("modalSubmitBtn").onclick = submitDefenseSug;
  }
};
window.closeModal = () => { document.getElementById("modalOverlay").style.display = "none"; };

function submitAttackSug() {
  const name = document.getElementById("mName").value;
  if(!name) return alert("ì´ë¦„ í•„ìˆ˜");
  push(ref(db, `suggestions/attack/${currentDefense}`), {
    name:name, type:document.getElementById("mType").value,
    ring:document.getElementById("mRing").value, pet:document.getElementById("mPet").value,
    armor:document.getElementById("mArmor").value, skill:document.getElementById("mSkill").value,
    suggester:myNick, timestamp:Date.now()
  });
  alert("ì œë³´ ì™„ë£Œ"); closeModal();
}

function submitDefenseSug() {
  const name = document.getElementById("mDefName").value;
  if(!name) return alert("ì´ë¦„ í•„ìˆ˜");
  push(ref(db, `suggestions/defense`), {
    name:name, heroes:document.getElementById("mHeroes").value,
    formation:document.getElementById("mForm").value, pet:document.getElementById("mPet").value,
    desc:document.getElementById("mDesc").value,
    suggester:myNick, timestamp:Date.now()
  });
  alert("ì œë³´ ì™„ë£Œ"); closeModal();
}

function renderRanking() {
  const list = document.getElementById("rankingList");
  onValue(ref(db,"logs"), snap => {
    allLogsCache = snap.val() || {};
    list.innerHTML = "";
    if(!Object.keys(allLogsCache).length) { list.innerHTML="<div style='text-align:center; padding:10px; color:#555'>ê¸°ë¡ ì—†ìŒ</div>"; return; }
    
    const stats = {};
    Object.values(allLogsCache).forEach(v => {
      if(!stats[v.nick]) stats[v.nick]={w:0,l:0,rw:0,rl:0,logs:[]};
      stats[v.nick].logs.push(v);
    });
    
    const rankData = Object.entries(stats).map(([n, d]) => {
      d.logs.sort((a,b)=>b.time-a.time);
      d.w = d.logs.filter(l=>l.result==="win").length;
      d.l = d.logs.filter(l=>l.result==="lose").length;
      const recent = d.logs.slice(0,30);
      d.rw = recent.filter(l=>l.result==="win").length;
      d.rl = recent.filter(l=>l.result==="lose").length;
      return { nick:n, ...d };
    }).sort((a,b) => b.w - a.w);

    const myD = rankData.find(x=>x.nick===myNick);
    if(myD) {
      const tot = myD.w+myD.l; 
      document.getElementById("myStats").textContent = `ë‚´ ì „ì : ${rankData.indexOf(myD)+1}ìœ„ / ${myD.w}ìŠ¹ ${myD.l}íŒ¨ (${tot?Math.round(myD.w/tot*100):0}%)`;
    }

    let hide = 0;
    rankData.forEach((d, i) => {
      if(!document.getElementById("attackAdminPanel").style.display.includes("block") && i>=10) { hide++; return; } 
      
      const tot = d.w+d.l;
      const r = tot ? Math.round(d.w/tot*100) : 0;
      const rTot = d.rw+d.rl;
      const rr = rTot ? Math.round(d.rw/rTot*100) : 0;
      
      const div = document.createElement("div");
      div.className = "rank-row";
      let badge = `<span style="width:20px; text-align:center; display:inline-block; color:#666;">${i+1}</span>`;
      if(i===0) badge="ğŸ¥‡"; if(i===1) badge="ğŸ¥ˆ"; if(i===2) badge="ğŸ¥‰";
      
      div.innerHTML = `
        <div>${badge} <span style="font-weight:bold; color:#fff;">${d.nick}</span></div>
        <div style="text-align:right;">
          <div style="font-size:0.9rem; color:#ccc;">${d.w}ìŠ¹ ${d.l}íŒ¨ (${r}%)</div>
          <div style="font-size:0.75rem; color:#666;">ìµœê·¼: ${d.rw}ìŠ¹ ${d.rl}íŒ¨ (${rr}%)</div>
        </div>
      `;
      list.appendChild(div);
    });
    document.getElementById("moreRankMsg").style.display = hide>0 ? "block":"none";
  });
}

window.issueKey = async () => {
  const n = document.getElementById("newUserNick").value;
  if(!n) return;
  const c = Math.floor(100000+Math.random()*900000);
  await set(ref(db, `allowedUsers/${n}`), { code:c, createdAt:Date.now() });
  document.getElementById("newUserNick").value="";
};

function renderUserKeys() {
  const div = document.getElementById("userKeyList");
  onValue(ref(db,"allowedUsers"), snap => {
    div.innerHTML="";
    const d = snap.val(); if(!d) return;
    Object.entries(d).forEach(([n,v]) => {
      const r = document.createElement("div");
      r.className = "key-row";
      r.innerHTML = `
        <div><b style="color:#fff">${n}</b> <span style="color:#AAA; margin-left:5px;">${v.code}</span></div>
        <button onclick="deleteUser('${n}')" style="background:#700; color:#fff; font-size:0.7rem; padding:3px 6px;">ì‚­ì œ</button>
      `;
      div.appendChild(r);
    });
  });
}
window.deleteUser = async (n) => {
  if(!confirm("ì‚­ì œ?")) return;
  await remove(ref(db, `allowedUsers/${n}`));
};

function renderAdminUserList() {
  const div = document.getElementById("adminUserList");
  // (ìœ ì € ìŠ¹íŒ¨ ìˆ˜ì • ë¡œì§ ìƒëµ)
}
</script>
</body>
</html>
